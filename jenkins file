pipeline {
    agent any 

    tools {
        maven 'naveen' 
    }

    environment {
        KOPS_STATE_STORE = "s3://leela.k8s.locals"
        KUBECONFIG = "${WORKSPACE}/kubeconfig"
    }

    stages {

        stage('Git Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/LeelaNaveen123/project-ecr.git'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                sh 'sh sonar.sh'
            }
        }

        stage('Run Scripts') {
            steps {
                sh 'sh project.sh'
            }
        }

        stage('Compile') {
            steps {
                sh 'mvn compile'
            }
        }

        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }

        stage('Package') {
            steps {
                sh 'mvn package'
            }
        }

        stage('Install') {
            steps {
                sh 'mvn install'
            }
        }

        stage('Kubernetes Authentication') {
            steps {
                sh '''
                echo "Exporting kubeconfig from kops..."
                kops export kubeconfig --name leela.k8s.local --admin --kubeconfig $KUBECONFIG

                echo "Verifying cluster access..."
                kubectl get nodes
                '''
            }
        }

        stage('Deployment') {
            steps {
                sh '''
                echo "Applying Kubernetes deployment..."
                kubectl apply -f dep.yml
                kubectl rollout status deployment/mydep
                '''
            }
        }
    }

    post {
        failure {
            sh '''
            echo "Deployment failed. Dumping cluster info..."
            kubectl cluster-info dump
            '''
        }
    }
}
